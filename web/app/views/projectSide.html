<div class="col-sm-{{ side.columnWidth() }} side" id="side-{{side.direction}}">

  <div ng-if="side.state.projectName === undefined && side.showSelector">
    <project-selector name="side.state.projectName"></project-selector>
  </div>

  <progressbar ng-if="side.project && !side.project.$resolved" value="100" class="progress-striped active">
  Loading...
  </progressbar>

  <div class="panel panel-danger" ng-if="side.project.$error">
    <div class="panel-heading project-name">
      {{side.state.projectName}}

      <div class="btn-group pull-right">
        <label class="btn btn-default"
               ng-click="side.close()"
               id="close-project"
               tooltip="Close&nbsp;project"
               tooltip-append-to-body="true"
               tooltip-placement="bottom">
          <i class="glyphicon glyphicon-remove"></i>
        </label>
      </div>
      <div class="clearfix"></div>
    </div>
    <div class="panel-body">
      Could not load project.
      <i class="pull-right"><a href ng-click="side.reportLoadingError()">report problem</a></i>
    </div>
  </div>

  <project-history side="side" show="side.project.$resolved && !side.project.$error && side.showHistory">
  </project-history>
  <workflow-editor side="side" state="side.workflowEditor" ng-if="side.project.$resolved && !side.project.$error && side.workflowEditor.enabled">
  </workflow-editor>

  <div class="project" ng-if="side.project.$resolved && !side.project.$error && !side.showHistory && !side.workflowEditor.enabled">

    <div class="btn-group pull-right">
      <label class="btn btn-default"
             ng-disabled="!side.project.undoOp"
             ng-click="side.undo()"
             id="undo-button"
             ng-if="!side.isSegmentation()"
             tooltip="Undo {{side.project.undoOp}}"
             tooltip-append-to-body="true"
             tooltip-placement="bottom">
        <i class="glyphicon glyphicon-backward"></i>
      </label>
      <label class="btn btn-default history-button"
             ng-click="side.showHistory = !side.showHistory"
             ng-if="!side.isSegmentation()"
             tooltip="History"
             tooltip-append-to-body="true"
             tooltip-placement="bottom">
        <i class="glyphicon glyphicon-time"></i>
      </label>
      <label class="btn btn-default"
             ng-disabled="!side.project.redoOp"
             ng-click="side.redo()"
             id="redo-button"
             ng-if="!side.isSegmentation()"
             tooltip="Redo {{side.project.redoOp}}"
             tooltip-append-to-body="true"
             tooltip-placement="bottom">
        <i class="glyphicon glyphicon-forward"></i>
      </label>
      <!-- "Save as" is closed. The floppy reveals the input box. -->
      <label class="btn btn-default"
             ng-click="side.startSavingAs()"
             ng-if="!side.showSaveAs && !side.isSegmentation()"
             id="save-as-starter-button"
             tooltip="Save&nbsp;as..."
             tooltip-append-to-body="true"
             tooltip-placement="bottom">
        <i class="glyphicon glyphicon-floppy-disk"></i>
      </label>
      <!-- "Save as" is open. The floppy sends the request (if something was entered) and hides the input box. -->
      <label class="btn btn-default"
             ng-if="side.showSaveAs && !side.isSegmentation()"
             ng-click="side.maybeSaveAs()"
             tooltip="{{side.saveAsName === side.state.projectName ? 'Enter new name' : 'Click the icon to save as ' + side.saveAsName}}"
             tooltip-append-to-body="true" tooltip-placement="bottom">
        <form ng-submit="side.maybeSaveAs()" style="display: inline;">
          <input class="form-control save-as" ng-model="side.saveAsName" ng-click="$event.stopPropagation();" id='save-as-input'>
        </form>
        <i id="save-as-button" class="glyphicon glyphicon-floppy-disk"></i>
      </label>
      <label class="btn btn-{{ side.showSettings ? 'primary' : 'default' }}"
             ng-click="side.showSettings = !side.showSettings"
             ng-if="!side.isSegmentation()"
             tooltip="Project&nbsp;settings"
             tooltip-append-to-body="true"
             tooltip-placement="bottom"
             ng-show="util.globals.hasAuth">
        <i class="glyphicon glyphicon-cog"></i>
      </label>
      <label class="btn btn-default"
             ng-click="side.close()"
             id="close-project"
             tooltip="Close&nbsp;project"
             tooltip-append-to-body="true"
             tooltip-placement="bottom">
        <i class="glyphicon glyphicon-remove"></i>
      </label>
    </div>

    <div class="btn-group pull-right" ng-if="side.project.vertexSet">
      <label class="btn btn-default"
             id="bucketed-mode-button"
             ng-model="side.state.graphMode"
             btn-radio="'bucketed'"
             uncheckable
             tooltip="Bucketed&nbsp;graph"
             tooltip-append-to-body="true"
             tooltip-placement="bottom">
        <i class="glyphicon glyphicon-th"></i>
      </label>
      <label class="btn btn-default"
             id="sampled-mode-button"
             ng-model="side.state.graphMode"
             btn-radio="'sampled'"
             uncheckable
             tooltip="Concrete&nbsp;vertices"
             tooltip-append-to-body="true"
             tooltip-placement="bottom">
        <i class="glyphicon glyphicon-eye-open"></i>
      </label>
    </div>

    <div class="btn-group pull-right" ng-if="side.hasFilters()">
      <label class="btn btn-default bypass-disabled"
             ng-click="side.applyFiltersEnabled() && side.applyFilters()"
             ng-disabled="!side.applyFiltersEnabled()"
             tooltip="Apply&nbsp;current&nbsp;filters: {{side.filterSummary()}}"
             tooltip-append-to-body="true"
             tooltip-placement="bottom"
             id="apply-filters-button">
        <i class="glyphicon glyphicon-filter"></i>
      </label>
      <label class="btn btn-default"
             ng-click="side.clearFilters()"
             tooltip="Discard&nbsp;current&nbsp;filters: {{side.filterSummary()}}"
             tooltip-append-to-body="true"
             tooltip-placement="bottom">
        <i class="glyphicon glyphicon-minus"></i>
      </label>
    </div>

    <help-popup href="project-header-buttons" class="pull-right"></help-popup>

    <div class="project-name">
      <span ng-class="unconnectedSides() ? 'warning' : 'de-emph'" ng-repeat="parent in side.parentProjects()">
        {{parent}} &raquo;
      </span>
      {{side.shortName()}}
    </div>

    <div class="clearfix"></div>

    <!-- Summary. -->
    <span ng-if="side.scalars['!belongsToEdges'] === undefined">
      <!-- Project summary -->
      <value id="vertex-count"
             class="emph"
             ng-if="side.project.vertexSet !== ''"
             ref="side.scalars['vertex_count']">
      </value>
      <delta ref="side.scalars['!vertex_count_delta']"
             last-operation="side.project.undoOp"></delta>
      <span class="emph" ng-if="side.project.vertexSet === ''">no</span>
      vertices with
      <value class="emph"
             ng-if="side.project.edgeBundle !== ''"
             ref="side.scalars['edge_count']"
             id="edge-count">
      </value>
      <delta ref="side.scalars['!edge_count_delta']"
             last-operation="side.project.undoOp"></delta>
      <span class="emph" ng-if="side.project.edgeBundle === ''">no</span>
      edges
    </span>

    <span ng-if="side.scalars['!belongsToEdges'] !== undefined">
      <!-- Segmentation summary -->
      <value class="emph"
             ref="side.scalars['vertex_count']"
             id="segment-count">
      </value>
      <delta ref="side.scalars['!vertex_count_delta']"
             last-operation="side.project.undoOp"></delta>
      <span ng-if="side.scalars['!nonEmpty'].double === side.scalars['vertex_count'].double">
        non-empty segments
      </span>
      <span ng-if="side.scalars['!nonEmpty'].double !== side.scalars['vertex_count'].double">
        segments (of which <value id="non-empty-segment-count" class="emph" ref="side.scalars['!nonEmpty']"></value> are non-empty)
      </span>
      with total size of <value id="total-segment-size" class="emph" ref="side.scalars['!belongsToEdges']"></value>
      covering <value id="total-segment-coverage" class="emph" ref="side.scalars['!coverage']"></value> base vertices
      <span ng-if="side.project.edgeBundle !== ''">
        with <value id="segmentation-edge-count" class="emph" ref="side.scalars['edge_count']"></value>
        <delta ref="side.scalars['!edge_count_delta']"
               last-operation="side.project.undoOp"></delta>
        edges
      </span>
    </span>

    <div class="project-notes">
      <textarea class="project-notes"
                placeholder="Enter project notes here"
                rows="{{side.project.notes.split('\n').length}}"
                ng-model="side.project.notes"
                ng-change="side.unsavedNotes = true"
                ng-trim="false"></textarea>
      <button ng-if="side.unsavedNotes"
              ng-click="side.saveNotes()"
              ng-disabled="side.savingNotes"
              class="btn btn-default">
        {{ side.savingNotes ? '...' : 'Save' }}
      </button>
    </div>

    <!-- Project settings. -->
    <div class="acl-settings" ng-if="side.showSettings">
      <acl-settings reload="side.reload()" path="side.state.projectName" entity="side.project"></acl-settings>
    </div>

    <div class="entity-sections">
      <div ng-repeat="section in side.sections">
        <div ng-show="side.sectionElements(section).length !== 0 && side.showSection(section)">
          <help-popup href="{{ side.sectionHelp[section] }}" class="pull-right"></help-popup>
          <div class="entity-section-label" ng-click="side.showSection(section, false)">
            {{ side.sectionHumanName[section] }} </div>
        </div>
        <div ng-show="side.sectionElements(section).length !== 0 && !side.showSection(section)"
             class="entity-section-label" ng-click="side.showSection(section, true)">
          {{ side.sectionElements(section).length }}
          {{ side.sectionHumanName[section] | lowercase }}
          are hidden. </div>
        <div class="entity-list" ng-show="side.showSection(section)">
          <entity ng-repeat="e in side.sectionElements(section)"
                  kind="{{ section }}"
                  entity="e"
                  side="side"></entity>
        </div>
      </div>
    </div>

    <!-- Extra controls for visualizations. -->
    <div class="entity-section-label"
         ng-show="side.state.graphMode && !side.showSection('view-settings')"
         ng-click="side.showSection('view-settings', true)"> View settings are hidden. </div>
    <div class="extra-controls" ng-if="side.state.graphMode && side.showSection('view-settings')">
      <!-- Sampled view extra controls. -->
      <div ng-if="side.state.graphMode === 'sampled'">
        <help-popup class="pull-right" href="concrete-view-settings"></help-popup>
        <div class="entity-section-label"
             ng-click="side.showSection('view-settings', false)"> Sampled view settings </div>
        <table>
          <tr>
            <td>Display:</td>
            <td>
              <div class="btn-group">
                <label class="btn btn-default"
                       ng-model="side.state.display"
                       btn-radio="'svg'">
                  2D
                </label>
                <label class="btn btn-default"
                       ng-model="side.state.display"
                       btn-radio="'3d'">
                  3D
                </label>
              </div>
            </td>
          </tr>
          <tr ng-if="side.state.display === 'svg'">
            <td>Layout animation:</td>
            <td>
              <div class="btn-group">
                <label class="btn btn-default"
                       ng-model="side.state.animate.enabled"
                       btn-radio="true">
                  <i class="glyphicon glyphicon-play"></i>
                </label>
                <label class="btn btn-default"
                       ng-model="side.state.animate.enabled"
                       btn-radio="false">
                  <i class="glyphicon glyphicon-pause"></i>
                </label>
              </div>
            </td>
          </tr>
          <tr ng-if="side.state.display === 'svg'">
            <td ng-class="{ 'de-emph': !side.state.animate.enabled }"
                tooltip-append-to-body="true"
                tooltip-placement="right"
                tooltip="{{ !side.state.animate.enabled ? 'Animation is off.' : '' }}">
              Label attraction:
            </td>
            <td>
              <input ng-disabled="!side.state.animate.enabled"
                     tooltip="{{side.state.animate.labelAttraction * 100}}%"
                     type="range"
                     max="1"
                     step="0.1"
                     ng-model="side.state.animate.labelAttraction">
            </td>
          </tr>
          <tr ng-if="side.state.display === 'svg'">
            <td ng-class="{ 'de-emph': !side.state.animate.enabled }"
                tooltip-append-to-body="true" tooltip-placement="right"
                                              tooltip="{{ !side.state.animate.enabled ? 'Animation is off.' : '' }}">
              Layout style:
            </td>
            <td>
              <select ng-disabled="!side.state.animate.enabled"
                      ng-model="side.state.animate.style"
                      class="form-control">
                <option value="neutral" title="Vertices with large degrees act as centers themselves.">Neutral</option>
                <option value="centralize" title="Vertices with large degrees tend to be in the middle.">Centralize</option>
                <option value="decentralize" title="Vertices with large degrees tend to be on the periphery.">Decentralize</option>
              </select>
            </td>
          </tr>
          <tr>
            <td>Show vertices:</td>
            <td>
              <div id="sample-center"
                   ng-class="{ loading: side.centerRequest && !side.centerRequest.$resolved }">
                <input class="form-control"
                       id="centers"
                       ng-model="side.state.centers"
                       ng-model-options="{ updateOn: 'change blur' }"
                       ng-list>
              </div>
            </td>
          </tr>
        </table>
        <pick-options side="side"></pick-options>
        <table>
          <tr>
            <td ng-class="{ 'de-emph': side.project.edgeBundle === '' }"
                tooltip-append-to-body="true"
                tooltip-placement="right"
                tooltip="{{ side.project.edgeBundle === '' ? 'No edges.' : '' }}">
              Show neighborhood:
            </td>
            <td>
              <input ng-disabled="side.project.edgeBundle === ''"
                     id="sample-radius-slider"
                     tooltip="radius {{side.state.sampleRadius}}"
                     type="range"
                     max="10"
                     step="1"
                     ng-model="side.state.sampleRadius">
            </td>
          </tr>
        </table>
      </div>

      <!-- Extra controls for the bucketed view. -->
      <div ng-if="side.state.graphMode === 'bucketed'">
        <div class="entity-section-label"
             ng-click="side.showSection('view-settings', false)"> Bucketed view settings </div>
        <table>
          <tr>
            <td>Buckets:</td>
            <td>
              <lazy-slider value="side.state.bucketCount"></lazy-slider>
            </td>
          </tr>
          <tr>
            <td>
              Compute precise bucket sizes:
            </td>
            <td>
              <input type="checkbox" ng-model="side.state.preciseBucketSizes">
            </td>
          </tr>
          <tr>
            <td>
              <help-popup href="relative-edge-density"></help-popup>
              Relative edge density:
            </td>
            <td>
              <input type="checkbox" ng-model="side.state.relativeEdgeDensity">
            </td>
          </tr>
        </table>
      </div>

      <div ng-if="side.state.graphMode">
        <text-dialog id="save-visualization-dialog"
                     button-text="Save Visualization"
                     on-ok="side.saveStateToBackend(userText, finishedCallback)"
                     start-value="visualization 1">
        </text-dialog>
        <help-popup href="saving-visualizations"></help-popup>
      </div>

    </div>

    <div class="sql-box-section">
      <help-popup ng-show="side.showSection('sql')"
                  href="sql-box"
                  class="pull-right" ></help-popup>
        <div class="entity-section-label"
             ng-click="side.showSection('sql', !side.showSection('sql'))"> SQL </div>
        <sql-box ng-show="side.showSection('sql')" side="side"></sql-box>
    </div>
  </div>
</div>
