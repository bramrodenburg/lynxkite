<div
    id="workspace-drawing-board"
    ng-mousemove="onMouseMove($event)"
    ng-mouseup="onMouseUp($event)"
    ng-mousedown="onMouseDown($event)">
  <svg>
    <g id="drawing-board"
       ng-attr-transform="{{ workspaceTransform() }}">

      <!-- start box -->
      <g ng-repeat="box in workspace.boxes()"
          ng-mousedown="onMouseDownOnBox(box, $event)"
          ng-dblclick="workspace.onDoubleClickOnBox(box)"
          ng-attr-transform="{{ box.mainPosTransform() }}"
          class="box"
          id="{{ box.instance.id }}"
          ng-class="{ 'selected': workspace.selectedBoxIds.includes(box.instance.id) }">

        <!-- start list of I/O plugs -->
        <g ng-repeat="direction in ['inputs', 'outputs']"
          id="{{ direction }}">
          <g ng-repeat="plug in box[direction]"
              ng-attr-transform="{{ plug.posTransform }}"
              id="{{ plug.id }}">
            <text x="10">{{ plug.id }}</text>
            <circle ng-attr-r="{{ plug.radius }}"
                  class="io-circle"
                  ng-class="{'in-progress': plug.inProgress,
                            'colored-output': plug.progressColor || plug.error }"
                  ng-attr-fill="{{ plug.error ? 'red' : plug.progressColor }}"
                  ng-attr-drop-tooltip="{{ plug.error }}"
                  ng-mousedown="workspace.onMouseDownOnPlug(plug, $event)"
                  ng-mouseup="workspace.onMouseUpOnPlug(plug, $event)"
                  ng-dblclick="workspace.onDoubleClickOnPlug(plug, $event)">
            </circle>
          </g>
        </g>
        <!-- end list of I/O plugs -->

        <rect
            class="box-main"
            ng-attr-width="{{box.width}}"
            ng-attr-height="{{box.height}}">
        </rect>

        <text x="5" y="15">
          {{box.metadata.operationID}}
        </text>
        <text x="5" y="50" ng-show="box.commentLines">
          <tspan xml:space="preserve" font-family="monospace" x="5" dy="15"
                 ng-repeat="line in box.commentLines track by $index">{{line}}
          </tspan>
        </text>
      </g>
      <!-- end box -->
      <g>
      <rect
        class="selection-box"
        ng-attr-x="{{workspace.selection.leftX}}"
        ng-attr-y="{{workspace.selection.upperY}}"
        ng-attr-width="{{workspace.selection.width}}"
        ng-attr-height="{{workspace.selection.height}}">
      </rect>
    </g>
      <!-- start arrow -->
      <g ng-repeat="arrow in workspace.arrows()">
        <line class="arrow"
            ng-attr-x1="{{arrow.x1()}}"
            ng-attr-y1="{{arrow.y1()}}"
            ng-attr-x2="{{arrow.x2()}}"
            ng-attr-y2="{{arrow.y2()}}"></line>
      </g>
      <!-- end arrow -->

      <!-- start pulled arrow -->
      <g ng-if="workspace.pulledPlug">
        <line class="arrow pulled-arrow"
            ng-attr-x1="{{workspace.pulledPlug.x()}}"
            ng-attr-y1="{{workspace.pulledPlug.y()}}"
            ng-attr-x2="{{workspace.mouseLogical.x}}"
            ng-attr-y2="{{workspace.mouseLogical.y}}">
        </line>
      </g>

    </g>
  </svg>

  <div id="popups">
    <div
        class="popup"
        ng-repeat="popup in workspace.popups"
        ng-style="{'left': popup.x + 'px', 'top': popup.y + 'px'}">
      <div
          class="popup-head"
          ng-mousedown="popup.onMouseDown($event)">
        {{popup.id}}
        <div class="btn-group pull-right" style="font-size: 5px;">
          <a class="btn btn-default"
               ng-click="popup.close(); event.stopPropagation();"
               id="close-popup"
               tooltip="Close&nbsp;popup"
               tooltip-append-to-body="true"
               tooltip-placement="bottom">
            <i class="glyphicon glyphicon-remove"></i>
          </a>
        </div>
      </div>
      <div class="popup-content"
            ng-mousedown="$event.stopPropagation()"
            ng-mouseup="$event.stopPropagation()">
        <box-editor ng-if="popup.content.type === 'box'"
            workspace="workspace"
            box-id="popup.content.boxId">
        </box-editor>
        <state-view ng-if="popup.content.type === 'plug'"
            workspace="workspace"
            state-id="popup.content.stateId"
            state-kind="popup.content.stateKind">
        </state-view>
      </div>
    </div>
  </div>
</div>
