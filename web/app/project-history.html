<div class="panel panel-default project history" ng-if="show && !workflowMode.enabled">

  <div class="panel-heading project-name" ng-show="!workflowMode.enabled">
    <span class="de-emph" ng-repeat="parent in side.parentProjects()">
      {{parent}} &raquo;
    </span>
    {{side.shortName()}}

    <div class="btn-group pull-right">
      <label class="btn btn-default" ng-click="enterWorkflowSaving()"
        tooltip="Save as Workflow" tooltip-append-to-body="true" tooltip-placement="bottom">
        <i class="glyphicon glyphicon-film"></i>
      </label>
      <label class="btn btn-info active" ng-click="closeHistory()"
        tooltip="History" tooltip-append-to-body="true" tooltip-placement="bottom">
        <i class="glyphicon glyphicon-time"></i>
      </label>
      <label class="btn btn-default" ng-click="closeProject()"
        tooltip="Close&nbsp;project" tooltip-append-to-body="true" tooltip-placement="bottom">
        <i class="glyphicon glyphicon-remove"></i>
      </label>
    </div>

    <div class="btn-group pull-right" ng-if="localChanges || remoteChanges">
      <!-- Invalid local changes. -->
      <label class="btn btn-warning" ng-if="localChanges && localValidationResult() !== 'ok'"
        tooltip="Not ready for validation: {{localValidationResult()}}" tooltip-append-to-body="true" tooltip-placement="bottom">
        <i class="glyphicon glyphicon-exclamation-sign"></i>
      </label>
      <!-- Valid local changes. -->
      <label class="btn btn-default" ng-if="localChanges && localValidationResult() === 'ok'" ng-click="validate()"
        tooltip="Validate&nbsp;history {{listLocalChanges()}}" tooltip-append-to-body="true" tooltip-placement="bottom">
        <i class="glyphicon glyphicon-ok"></i>
      </label>
      <!-- Invalid remote changes. -->
      <label class="btn btn-warning" ng-if="!localChanges && !valid"
        tooltip="History is inconsitent {{listInvalidSteps()}}" tooltip-append-to-body="true" tooltip-placement="bottom">
        <i class="glyphicon glyphicon-exclamation-sign"></i>
      </label>
      <!-- Valid remote changes. "Save as" box is closed. -->
      <label class="btn btn-default" ng-if="!localChanges && remoteChanges && valid && !showSaveAs"
        ng-click="$parent.showSaveAs = true; $parent.saveAsName = side.state.projectName;"
        tooltip="History is valid. Click to save." tooltip-append-to-body="true" tooltip-placement="bottom">
        <i class="glyphicon glyphicon-floppy-disk"></i>
      </label>
      <!-- Valid remote changes. "Save as" box is open. -->
      <label class="btn btn-default" ng-if="!localChanges && remoteChanges && valid && showSaveAs"
        ng-click="saveAs(saveAsName)"
        tooltip="Click the icon to save as {{saveAsName}}" tooltip-append-to-body="true" tooltip-placement="bottom">
        <form ng-submit="saveAs(saveAsName)" style="display: inline;">
          <input class="form-control save-as" ng-disabled="saving"
            ng-model="saveAsName" ng-click="$event.stopPropagation()">
        </form>
        <i class="glyphicon glyphicon-floppy-disk"></i>
      </label>
    </div>

    <div class="clearfix"></div>
  </div>

  <div class="list-group" ng-show="!workflowMode.enabled">
    <li class="list-group-item uneditable" ng-if="!history.$resolved">
      <progressbar value="100" class="progress-striped active">
        Loading...
      </progressbar>
    </li>
    <li class="list-group-item invalid" ng-if="history.$error">
      Error loading history.
      <i class="pull-right"><a href ng-click="reportError()">report problem</a></i>
    </li>
    <li class="list-group-item uneditable" ng-if="history.skips">
      <div style="font-size: 30px">&hellip;</div>
      {{history.skips}} earlier {{history.skips === 1 ? 'step' : 'steps'}} cannot be edited.
    </li>
    <li class="list-group-item" ng-repeat="step in history.steps"
      ng-class="{ 'local-changes': step.localChanges, invalid: !step.status.enabled }"
      ng-init="cat = findCategory(step.opCategoriesBefore, step.request)">
      <div ng-hide="step.status.enabled" class="error">
        <i class="glyphicon glyphicon-exclamation-sign"></i>
        {{step.status.disabledReason}}
      </div>
      <div ng-show="segmentationName(step)" class="affected-segmentation">
        <i class="glyphicon glyphicon-arrow-right"></i> {{segmentationName(step)}}
      </div>
      <operation-toolbox
        categories="step.opCategoriesBefore"
        op="step.request.op.id"
        category="cat"
        params="step.request.op.parameters">
      </operation-toolbox>
      <div class="btn-group history-options pull-right" dropdown>
        <a href class="btn-dropdown dropdown-toggle" dropdown-toggle><span class="caret"></span></a>
        <ul class="dropdown-menu">
          <li><a href ng-click="discard(step)">
            <i class="glyphicon glyphicon-trash"></i> Discard operation
          </a></li>
          <li><a href ng-click="insertBefore(step)">
            <i class="glyphicon glyphicon-chevron-up"></i> Insert operation above
          </a></li>
          <li ng-repeat="seg in step.segmentationsBefore"><a href ng-click="insertBefore(step, seg)">
            <i class="glyphicon glyphicon-chevron-up"></i> Insert operation for {{seg.name}} above
          </a></li>
          <li><a href ng-click="insertAfter(step)">
            <i class="glyphicon glyphicon-chevron-down"></i> Insert operation below
          </a></li>
          <li ng-repeat="seg in step.segmentationsAfter"><a href ng-click="insertAfter(step, seg)">
            <i class="glyphicon glyphicon-chevron-down"></i> Insert operation for {{seg.name}} below
          </a></li>
        </ul>
      </div>

    </li>
  </div>
</div>
<workflow-saver ng-if="show" visible="workflowMode.enabled" code="code" side="side">
</workflow-saver>
