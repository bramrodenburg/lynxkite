#!/usr/bin/env python
import re
import subprocess

TEST_PATH = 'test/com/lynxanalytics/biggraph/graph_operations/SerialVersionUIDTest.scala'

def sbtErrors():
  print 'Running "sbt test". Please wait...'
  p = subprocess.Popen(['sbt', 'test'], stdout=subprocess.PIPE)
  stdout, stderr = p.communicate()
  return stdout

def getEntries(errors):
  return sorted(set(re.findall('Please add (.*) to SerialVersionUIDTest', errors)))

def formatEntries(entries):
  entries = sorted(set(entries))
  fmt = ['    ' + e + ',\n' for e in entries[:-1]]
  fmt.append('    ' + entries[-1] + ')\n')
  return fmt

def addToTest(newEntries):
  newSource = []
  with file(TEST_PATH) as f:
    for l in f:
      newSource.append(l)
      if 'Autogenerated by tools/SerialVersionUIDTest-update' in l:
        break
    oldEntries = []
    for l in f:
      if 'Autogenerated by tools/SerialVersionUIDTest-update' in l:
        newSource += formatEntries(oldEntries + newEntries)
        newSource.append(l)
        break
      oldEntries.append(l.strip()[:-1])
    for l in f:
      newSource.append(l)

  with file(TEST_PATH, 'w') as f:
    f.writelines(newSource)

def main():
  errors = sbtErrors()
  errorEntries = getEntries(errors)
  if errorEntries:
    addToTest(errorEntries)
    print 'Updated', TEST_PATH
  else:
    print 'No changes.'

if __name__ == '__main__':
  main()
